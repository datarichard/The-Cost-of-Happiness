---
title: "Supplementary material: The increasing cost of happiness"
author: "R.W. Morris^1,2^, N. Kettlewell^2,3,4^  & N.Glozier^1,5^"
bibliography: ../src/references.bib
csl: ../src/elsevier-harvard.csl
output:  
  html_document:
    reference_docx: ../src/academic_style.docx
always_allow_html: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(flextable)
library(bayesplot)
library(patchwork)

knitr::opts_chunk$set(eval = TRUE,
                      echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.path = "../figures/")
```
\  
\  

1. Central Clinical School, Faculty of Medicine and Health, University of Sydney, NSW, Australia
2. ARC Centre of Excellence for Children and Families over the Life Course, University of Queensland, QLD, Australia
3. School of Economics, University of Technology, NSW, Australia
4. Institute of Labor Economics (IZA), Bonn, Germany
5. Brain and Mind Centre, University of Sydney, NSW, Australia 

\  

**Corresponding author:**  
Professor Nick Glozier  
Faculty of Medicine and Health,   
University of Sydney,  
NSW 2050,  
Australia  
email: nick.glozier@sydney.edu.au  

\  

Draft: `r format(Sys.time(), '%d %B, %Y')`  
Supplementary tables:      4  
Supplementary figures:     3  
  
**keywords:** Subjective wellbeing, household wealth, HILDA  

\  

***


## Supplementary Material

#### Model Selection (2002-2018)  

##### Figure S1. Linear model evidence (WAIC~linear~ — WAIC~piecewise~)
```{r complete_waic}
waic_result <- read_rds("../results/model_comparisons_waic_R2_losat.RDS")

waic_result %>%
  select(model, year, elpd_diff, se_diff) %>%
  filter(elpd_diff != 0) %>%
  rowwise() %>%
  mutate(samples = list(rnorm(n = 1e5, 
                              mean = elpd_diff * -2, # for linear advantage
                              sd   = se_diff *  2)),
         year = paste0("AD", year)
         ) %>%
  select(year, samples) %>%
  group_by(year) %>%
  unnest(samples) %>% 
  mutate(sample_id = c(1:1e5)) %>%
  pivot_wider(id_col = "sample_id", names_from = "year", values_from = "samples") %>%
  select(-sample_id) -> d1

# "fix" d1
colnames(d1) <- rev(colnames(d1))

color_scheme_set("blue")

p2 <- mcmc_intervals(x = d1,
  pars = colnames(d1),
  prob = 0.0,
  prob_outer = .95
  ) +
  scale_x_continuous(
    limits = c(-200, 150)
    ) +
  geom_vline(aes(xintercept = 0), color = "grey90") +
  theme_test() +
  labs(
    subtitle = "Satisfaction",
    x = "WAIC difference (95% interval)")

waic_result <- read_rds("../results/model_comparisons_waic_R2_gh9.RDS")

waic_result %>%
  select(model, year, elpd_diff, se_diff) %>%
  filter(elpd_diff != 0) %>%
  rowwise() %>%
  mutate(samples = list(rnorm(n = 1e5, 
                              mean = elpd_diff * 2, # for pw advantage
                              sd   = se_diff *  2)),
         year = paste0("AD", year)
         ) %>%
  select(year, samples) %>%
  group_by(year) %>%
  unnest(samples) %>% 
  mutate(sample_id = c(1:1e5)) %>%
  pivot_wider(id_col = "sample_id", names_from = "year", values_from = "samples") %>%
  select(-sample_id) -> d2

color_scheme_set("red")

p1 <- mcmc_intervals(x = d2,
           pars = rev(colnames(d2)),
           prob = 0.00,
           prob_outer = 0.95
           ) +
  scale_x_continuous(
    limits = c(-200, 150)
    ) +
  geom_vline(aes(xintercept = 0), color = "grey90") +
  theme_test() +
  labs(
    subtitle = "Happiness")
```

```{r Figure_S1, fig.width=6.5, fig.height=7, dpi=300}
p1 / p2
```

```
Figure S1 legend: Differences in posterior evidence (WAIC) for a linear fit over a piecewise fit for satisfaction (blue) and happiness (red). The filled circle indicates the mean of the distribution and the horizontal bars represents the 95% credible interval. A difference greater than zero is support for the linear model and a difference below zero is support for the piecewise model.
```  

<br><br>

#### Parameter Estimation (2002-2018) 

##### Figure S2. Posterior distributions of &omega; (95% distribution)  
```{r gh9_omega}
path_to_gh9_fits <- list.files(
  path = "../results",
  pattern = '^fit_cp_hifdip_gh9_cov_.*.RDS$',
  full.names = TRUE
)

posterior_alphas <- list()
for (pathtofile in path_to_gh9_fits) {
  df <- read_rds(pathtofile) %>%
    as.data.frame() %>%
    select(b_alpha_Intercept) 
  
  colnames(df) <- paste0("param_", substring(pathtofile, 34, 37))
  
  posterior_alphas <- bind_cols(posterior_alphas, df)
}

posterior_alphas %>%
  mutate_all(.funs = ~brms::inv_logit_scaled(., 0, 100)*10) -> posterior_omegas

posteriors_trim <- posterior_omegas %>%
  mutate(
    # param_2010 = (param_2010 + param_2011)/2,
    param_2003 = (param_2002 + param_2004)/2)

color_scheme_set("red")

p3 <- mcmc_intervals(
  posteriors_trim,
  pars = rev(colnames(posteriors_trim)),
  prob = 0.0, 
  prob_outer = .95 
  ) +
  geom_vline(aes(xintercept = median(posteriors_trim$param_2002)), 
             color = "gray", 
             linetype = 3) +
  theme_test() +
  coord_cartesian(xlim = c(20, 200)) +
  labs(
    subtitle = "Happiness",
    x = "")
```

```{r losat_omega}
path_to_losat_fits <- list.files(
  path = "../results",
  pattern = '^fit_cp_hifdip_losat_cov_.*.RDS$',
  full.names = TRUE
)

posterior_alphas <- list()
for (pathtofile in path_to_losat_fits) {
  df <- read_rds(pathtofile) %>%
    as.data.frame() %>%
    select(b_alpha_Intercept) 
  
  colnames(df) <- paste0("param_", substring(pathtofile, 36, 39))
  
  posterior_alphas <- bind_cols(posterior_alphas, df)
}

posterior_alphas %>%
  mutate_all(.funs = ~brms::inv_logit_scaled(., 0, 100)*10) -> posterior_omegas

posteriors_trim <- posterior_omegas %>%
  mutate(
    param_2006 = (param_2007 + param_2005)/2)

color_scheme_set("blue")

p4 <- mcmc_intervals(
  posteriors_trim,
  pars = rev(colnames(posteriors_trim)),
  prob = 0.0, 
  prob_outer = .95 
  ) +
  geom_vline(aes(xintercept = median(posteriors_trim$param_2002)), 
             color = "gray", 
             linetype = 3) +
  theme_test() +
  coord_cartesian(xlim = c(20, 200)) +
  labs(
    subtitle = "Satisfaction",
    x = "Household income ($000s)")
```

```{r Figure_S2, fig.width = 6, fig.height = 7, dpi=300}
p3 / p4
```

```
Figure S2 legend: Posterior distribution of the change point parameter representing the location in household income ($) for each year. Horizontal bar represents the 95% credible interval.
``` 

<br>

#### Change point model parameter estimates  

There were _df_ = 59,876 total observations. 4000 samples (post-warmup) were drawn using sampling(NUTS). For each parameter, Bulk_ESS and Tail_ESS are effective sample size (ESS) measures, and Rhat is the potential scale reduction factor on split chains. In each case the Rhat apprached 1, indicating convergance. The smallest ESS was _n_ = 472, which is greater than a conservative estimate of the sufficient _n_ for estimation (*n* > 300).  

The Bayes R^2^ = 0.03964581 ±0.001497172 (0.03672371-0.04262236)  

<br>

_Coefficient definitions_:  

_alpha_ is the log value of wealth (x) at the changepoint  
_b0_ is the intercept denoting the expected value of wellbeing (y) at the changepoint  
_b1_ is the linear slope before the changepoint  
_b2_ is the linear slope after the changepoint  
_b3_ is the coefficient of education (graduate)  
_b4_ is the coefficient of age  
_b5_ is the coefficient of age^2^  
_b6_ is the coefficient of sex (male)  


<br>

```{r gh9_pw_summary, ft.align="left"}
population_summary <- tibble()
for (pathtofile in path_to_gh9_fits) {
  fit_summary <- read_rds(pathtofile) %>%
    summary() 
  
  sigma_summary <- fit_summary$spec_pars %>%
    as_tibble(rownames = "Parameter")
  
  fixed_summary <- fit_summary$fixed %>%
    as_tibble(rownames = "Parameter") %>%
    bind_rows(sigma_summary) %>%
    mutate(Year = substring(pathtofile, 34, 37)) %>%
    select(Parameter, Year, everything())
  
  population_summary <- bind_rows(population_summary, fixed_summary)
}

population_summary %>%
  mutate(Parameter = str_remove(Parameter, "_Intercept")) %>%
  arrange(Parameter, desc(Year)) %>%
  flextable() %>%
  merge_v(j = 1) %>%
  valign(j = 1, valign = "top") %>%
  bg(i = ~Parameter %in% c("b0", 
                           "b2", 
                           "b4", 
                           "b6"), 
     bg = "grey90", 
     part = "body") %>%
  bg(i = ~Parameter %in% c("sigma"), 
     bg = "#b3cde0", 
     part = "body") %>%
  colformat_num(j = 3:6, digits= 3) %>%
  colformat_num(j = 7, digits= 1) %>%
  set_caption("Table S1. Population-level piecewise parameter estimates for happiness") %>%
  autofit()
```

<br>

```{r gh9_lm_summary, ft.align="left"}
path_to_gh9_lm_fits <- list.files(
  path = "../results",
  pattern = '^fit_lm_hifdip_gh9_cov_.*.RDS$',
  full.names = TRUE
)

population_summary <- tibble()
for (pathtofile in path_to_gh9_lm_fits) {
  fit_summary <- read_rds(pathtofile) %>%
    summary() 
  
  sigma_summary <- fit_summary$spec_pars %>%
    as_tibble(rownames = "Parameter")
  
  fixed_summary <- fit_summary$fixed %>%
    as_tibble(rownames = "Parameter") %>%
    bind_rows(sigma_summary) %>%
    mutate(Year = substring(pathtofile, 34, 37)) %>%
    select(Parameter, Year, everything())
  
  population_summary <- bind_rows(population_summary, fixed_summary)
}

population_summary %>%
  mutate(Parameter = fct_relevel(Parameter, "Intercept", "dollars", "grad")) %>%
  arrange(Parameter, desc(Year)) %>%
  flextable() %>%
  merge_v(j = 1) %>%
  valign(j = 1, valign = "top") %>%
  bg(i = ~Parameter %in% c("dollars",
                           "age",
                           "male"),
     bg = "grey90",
     part = "body") %>%
  bg(i = ~Parameter %in% c("sigma"), 
     bg = "#b3cde0", 
     part = "body") %>%
  colformat_num(j = 3:6, digits= 3) %>%
  colformat_num(j = 7, digits= 1) %>%
  set_caption("Table S2. Population-level linear parameter estimates for happiness") %>%
  autofit()
```

<br>

```{r losat_pw_summary, ft.align="left"}
population_summary <- tibble()
for (pathtofile in path_to_losat_fits) {
  fit_summary <- read_rds(pathtofile) %>%
    summary() 
  
  sigma_summary <- fit_summary$spec_pars %>%
    as_tibble(rownames = "Parameter")
  
  fixed_summary <- fit_summary$fixed %>%
    as_tibble(rownames = "Parameter") %>%
    bind_rows(sigma_summary) %>%
    mutate(Year = substring(pathtofile, 36, 39)) %>%
    select(Parameter, Year, everything())
  
  population_summary <- bind_rows(population_summary, fixed_summary)
}

population_summary %>%
  mutate(Parameter = str_remove(Parameter, "_Intercept")) %>%
  arrange(Parameter, desc(Year)) %>%
  flextable() %>%
  merge_v(j = 1) %>%
  valign(j = 1, valign = "top") %>%
  bg(i = ~Parameter %in% c("b0", 
                           "b2", 
                           "b4", 
                           "b6"), 
     bg = "grey90", 
     part = "body") %>%
  bg(i = ~Parameter %in% c("sigma"), 
     bg = "#b3cde0", 
     part = "body") %>%
  colformat_num(j = 3:6, digits= 3) %>%
  colformat_num(j = 7, digits= 1) %>%
  set_caption("Table S3. Population-level piecewise parameter estimates for satisfaction") %>%
  autofit()
```

<br>

```{r losat_lm_summary, ft.align="left"}
path_to_losat_lm_fits <- list.files(
  path = "../results",
  pattern = '^fit_lm_hifdip_losat_cov_.*.RDS$',
  full.names = TRUE
)

population_summary <- tibble()
for (pathtofile in path_to_gh9_lm_fits) {
  fit_summary <- read_rds(pathtofile) %>%
    summary() 
  
  sigma_summary <- fit_summary$spec_pars %>%
    as_tibble(rownames = "Parameter")
  
  fixed_summary <- fit_summary$fixed %>%
    as_tibble(rownames = "Parameter") %>%
    bind_rows(sigma_summary) %>%
    mutate(Year = substring(pathtofile, 34, 37)) %>%
    select(Parameter, Year, everything())
  
  population_summary <- bind_rows(population_summary, fixed_summary)
}

population_summary %>%
  mutate(Parameter = fct_relevel(Parameter, "Intercept", "dollars", "grad")) %>%
  arrange(Parameter, desc(Year)) %>%
  flextable() %>%
  merge_v(j = 1) %>%
  valign(j = 1, valign = "top") %>%
  bg(i = ~Parameter %in% c("dollars",
                           "age",
                           "male"),
     bg = "grey90",
     part = "body") %>%
  bg(i = ~Parameter %in% c("sigma"), 
     bg = "#b3cde0", 
     part = "body") %>%
  colformat_num(j = 3:6, digits= 3) %>%
  colformat_num(j = 7, digits= 1) %>%
  set_caption("Table S4. Population-level linear parameter estimates for happiness") %>%
  autofit()
```


<br><br>


##### Figure S3. Residual plots for piecewise happiness models
```{r figure_s3, fig.height=9, fig.width=9}
# https://www.flutterbys.com.au/stats/tut/tut7.2b.html
# resid = resid(data.brms)[, "Estimate"]
# fit = fitted(data.brms)[, "Estimate"]

resid_df <- readRDS("../results/residual_data.RDS")

resid_df %>%
  group_by(year) %>%
  slice_sample(n = 1000) %>% # to reduce overplotting
  ggplot(aes(x = fitteds, y = resids)) +
    geom_point(alpha = 0.1, size = 0.5) +
    facet_wrap(~year, scales = "free") +
    theme_test()
```


```
Figure S3 legend: The joint distribution between residual and fitted values shows no common patterns across years and appears clustered around zero in each case.
``` 

<br>

Examination of the residual plots from the piecewise models of happiness confirms the residuals were evenly distributed around zero and there was little indication of heterscedascity. There was little evidence that the piecewise models of happiness were not appropriate for the data.  


<br><br>

#### Non-linear fits

We tested the relationship between wealth and each wellbeing variable (happiness and satisfaction) using cubic **B-spline models**. A cubic B-spline was the most complex model (more degrees of freedom), and included here because it has been recently used to describe the maximum point at which wellbeing no longer increases with wealth [i.e., "satiety", @jebb2018happiness]. Following Jebb et al [-@jebb2018happiness], we restricted the cubic B-spline model to *n* = 4, 5 and 6 knots and display wealth on a log scale.  

<br>

##### Figure S4. Cubic spline of household wealth on satisfaction and happiness
```{r losat_gh9_hwnwip}
source("../src/happyfun.r")
happywealth <- read_rds("../data/happywealth.rds")

p1 <- happywealth %>%
  filter(hifdip_adj > 0) %>%
  rename(Satisfaction = losat, `Household wealth` = hifdip_adj) %>% 
  plot_inflection_cubic(Satisfaction, `Household wealth`) +
  scale_x_continuous(trans = "log", 
                     breaks = c(5, 10, 20, 40, 80, 160),
                     limits = c(2.5, 170))

p2 <- happywealth %>%
  filter(hifdip_adj > 0) %>%
  rename(Happiness = gh9, `Household wealth` = hifdip_adj) %>% 
  plot_inflection_cubic(Happiness, `Household wealth`) +
  scale_x_continuous(trans = "log", 
                     breaks = c(5, 10, 20, 40, 80, 160),
                     limits = c(2.5, 170))
```
```{r cubic_plot, fig.height=9, fig.width=11}
p1 / p2
```

<br>

The cubic B-spline models failed to reveal a complete satiety point (horizontal inflection) in satisfaction before the highest decile in any year. Also note that despite using a log scale, we do not observe a clear, regular logarithmic function with either wellbeing measure. Other researchers have argued that wealth represents a quantitative dimension subject to Weber's Law of perception [@kahneman2010high]. Under this view, similar proportional changes in income or wealth produce similar evaluations of satisfaction or happiness, rather than the absolute change. That is, a \$100 increase in wealth will produce a greater impact on someone earning a minimum wage than someone earning many orders of magnitude of that amount. However while it is true that wealth clearly represents a quantitative dimension, the effects of wealth observed here represent cross-sectional differences in the population rather than changes experienced by an individual over time. It is not clear the extent to which Weber's Law applies to cross-sectional or between-subject differences in quantitative dimensions such as wealth.     

<br><br>

##### Figure S5. Prior predictive plot
(Not included)

```{r figure_s5, eval=F}
# prior_fit <- readRDS("../results/prior_nl_hifdip_losat_cov_2018.RDS")

# Check priors. The fixed estimates should be near zero, the fixed error should
# be ~3 respectively
# 
# summary(prior_fit)

# Extract prior predictions
# d <- data.frame(predict(prior_fit)) # takes a long time to run
# prior_predictions <- bind_cols(prior_fit$data, d)
# write_rds(prior_predictions, "../results/prior_prediction_data.RDS")

prior_predictions <- read_rds("../results/prior_prediction_data.RDS")

prior_predictions %>%
  mutate(
      dollar_bin = ntile(dollars, 10)
      ) %>%
    group_by(dollar_bin) %>%
    summarize(
      wellbeing = mean(Estimate, na.rm=T),
      wealth = mean(dollars, na.rm=T),
      n = n()
    ) -> df.deciles

prior_predictions %>%
  rename(wellbeing = Estimate,
         wealth = dollars) -> df.plot 

# piecewise model
p0 <- ggplot(df.deciles, aes(x = wealth, y = wellbeing)) +
  geom_point() +
  geom_smooth(data = df.plot,
              aes(x = wealth, y = wellbeing,
                  fill = "#C79999", color = "#8F2727"),
              size = 0.5) +
  coord_cartesian(xlim = c(0, max(df.deciles$wealth)),
                  ylim = c(min(df.deciles$wellbeing), max(df.deciles$wellbeing))
                  ) +
  theme_test() +
  theme(legend.position = "none")

p1 <- ggplot(df.deciles, aes(x = wealth, y = wellbeing)) +
  geom_point() +
  geom_smooth(data = df.plot,
              aes(x = wealth, y = wellbeing, fill = "manual"),
              method = "lm",
              size = 0.5) +
  coord_cartesian(xlim = c(0, max(df.deciles$wealth)),
                  ylim = c(min(df.deciles$wellbeing), max(df.deciles$wellbeing))
                  ) +
  theme_test() +
  theme(legend.position = "none") +
  scale_fill_manual(values = "#b3cde0")

source("happyfun.R")

p2 <- prior_predictions %>%
  rownames_to_column(var = "xwaveid") %>%
  mutate(year = 2018,
         dollars = dollars*10000) %>%
  rename(Wellbeing = Estimate, `Household income` = dollars) %>% 
  plot_inflection_piecewise(Wellbeing, `Household income`, knots = 1)

p3 <- prior_predictions %>%
  rownames_to_column(var = "xwaveid") %>%
  mutate(year = 2018,
         dollars = dollars*10000) %>%
  rename(Wellbeing = Estimate, `Household income` = dollars) %>% 
  plot_inflection_cubic(Wellbeing, `Household income`)

p4 <- prior_predictions %>%
  rownames_to_column(var = "xwaveid") %>%
  mutate(year = 2018,
         dollars = dollars*10000) %>%
  rename(Wellbeing = Estimate, `Household income` = dollars) %>% 
  plot_linear(Wellbeing, `Household income`) +
  scale_fill_manual(values = "#b3cde0") +
  scale_color_manual(values = "#005b96")

p0 + p1

p2 + p3 + p4
```

<br><br><br>

##### Figure S6. Marginal effect of wealth on satisfaction by year (95% CI)  
(Not included)
```{r figure_s6_df, eval=F}
# Do not run

library(brms)

# import the fits
nl_losat_paths <- list.files(
  path = "../results/no_topcodes/",
  pattern = "fit_nl_hifdip_losat_cov_*",
  full.names = TRUE
)

list_fits = list()
for (f in nl_losat_paths) {
  fit <- readRDS(f)
  list_fits[str_extract(f, "[[:digit:]]+")] <- list(fit)
}

# turn each fit into a plot dataframe (this takes a few minutes)
plot_data <- map_dfr(.x = list_fits, 
                     .f = function(x) conditional_effects(x)[[1]],
                     .id = "Year")

saveRDS(plot_data, "../results/nl_marginal_effects_losat.RDS")
```
```{r, figure_s6, eval=F}
readRDS("../results/nl_marginal_effects_losat.RDS") %>%
  ggplot(aes(x = dollars, y = estimate__, fill = Year)) +
    geom_ribbon(aes(ymin = lower__, ymax = upper__), alpha = 0.25) +
    geom_line(aes(color = Year)) +
    facet_wrap(~Year, scale = "free") +
    labs(y = "") +
    theme_test() +
    theme(legend.position = "none")
```

<br><br>

## References

