---
title: "Bin size experiments"
author: "Dr R. Morris, School of Medicine, University of Sydney"
date: "23/11/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE,
                      echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.path = "../figures/")

library(tidyverse)
```

## Depicting large data

This is a brief examination of the effect of the bin design on data visualization (e.g., scatter plots).  

HILDA provides income and household wealth data on approximately 10,000 individuals each year. When visualizing large datasets of n > 10,000 there are often too many points to distinguish patterns among the individuals or even the overall trend. Models, or some kind of summary function, is needed to provide an accurate or fair depiction of trends and patterns. Measures of central tendency, or the expected value can also be used to reduce the number of indiivdual points, however then the data must be grouped or binned. Binning can occur by equal length or equal size.  

```{r read_covs}
happywealth_covs <- read_rds("../data/happywealth_covs.rds")
```

```{r plot_all}
plot_all <- function(.data, swb_col, dollars_col) {
  
  swb_colname <- rlang::enexpr(swb_col)
  dollars_colname <- rlang::enexpr(dollars_col)
  
  .data %>%
    select(xwaveid, 
           year, 
           swb = !!swb_colname, dollars = !!dollars_colname) %>%
    filter(swb >= 0) %>%
    filter(dollars >= 0) %>%
    filter(year %in% c(2002, 2006, 2010, 2014, 2018)) -> df
  
  df %>%
    group_by(year) %>%
    summarise(n = n()) %>%
    mutate(note = paste("n =", format(n, big.mark = ","))) -> df.sum
  
  df %>%
    mutate(
      wealth = dollars/1000,
      wellbeing = swb
    ) -> df.plot
  
  # smooth 
  ggplot(df.plot, aes(x = wealth, y = wellbeing)) +
    geom_point(
      alpha = 0.05
      ) +
    geom_smooth(
      aes(fill = "manual1", color = "manual2"),
      method = "gam",
      size = 0.5
      ) +
    coord_cartesian(
      ylim = c(min(df.plot$wellbeing), max(df.plot$wellbeing))
      ) +
    facet_wrap(
      ~year, 
      nrow = 1,
      scales = "free_x"
      ) +
    labs(
      subtitle = paste(rlang::as_name(swb_colname), "(all)"),
      x = paste(rlang::as_name(dollars_colname), "($000s)"),
      y = ""
      ) +
    theme_test() +
    theme(
      legend.background = element_blank(),
      legend.title = element_blank(),
      legend.position = "none"
      ) -> p1
  
  p1 +
    geom_text(
      data = df.sum, 
      aes(x = Inf, y = -Inf, label = note),
      hjust = 1.1, vjust = -.75, colour = 1, size = 3)
  
}
```

```{r plot_cut_interval}
plot_cut_interval <- function(.data, swb_col, dollars_col) {
  
  swb_colname <- rlang::enexpr(swb_col)
  dollars_colname <- rlang::enexpr(dollars_col)
  
  .data %>%
    select(xwaveid, year, swb = enexpr(swb_col), dollars = enexpr(dollars_col)) %>%
    filter(swb >= 0) %>%
    filter(dollars >= 0) %>%
    filter(year %in% c(2002, 2006, 2010, 2014, 2018)) -> df
  
  df %>%
    mutate(
      wealth = dollars/1000,
      wellbeing = swb
    ) -> df.plot
  
  df %>%
    group_by(year) %>%
    mutate(
      dollar_bin = cut_interval(dollars, 10)
      ) %>%
    group_by(year, dollar_bin) %>%
    summarize(
      wellbeing = mean(swb, na.rm=T),
      wealth = mean(dollars, na.rm=T)/1000,
      n = n()
      ) -> df.summary
  
  # smooth
  ggplot(df.plot, aes(x = wealth, y = wellbeing)) +
    geom_smooth(
      aes(fill = "manual1", color = "manual2"),
      method = "gam", 
      size = 0.5
      ) +
    facet_wrap(~year, nrow = 1, scale = "free_x") +
    labs(
      subtitle = paste(rlang::as_name(swb_colname), "(equal intervals)"),
      x = paste(rlang::as_name(dollars_colname), "($000s)"),
      y = "") +
    theme_test() +
    theme(
      legend.position = "none") -> p1
  
  p1 +
    geom_point(data = df.summary, aes(size = sqrt(n)), alpha = 0.5)
}
```

```{r plot_deciles}
plot_deciles <- function(.data, swb_col, dollars_col) {
 

  swb_colname <- rlang::enexpr(swb_col)
  dollars_colname <- rlang::enexpr(dollars_col)
  
  .data %>%
    select(xwaveid, 
           year, 
           swb = !!swb_colname, dollars = !!dollars_colname) %>%
    filter(swb >= 0) %>%
    filter(dollars >= 0) %>%
    filter(year %in% c(2002, 2006, 2010, 2014, 2018)) -> df
  
  df %>%
    group_by(year) %>%
    summarise(n = n()) %>%
    mutate(note = paste("n =", format(n, big.mark = ","))) -> df.sum
  
  df %>%
    group_by(year) %>%
    mutate(
      dollar_bin = ntile(dollars, 10)
    ) %>%
    group_by(year, dollar_bin) %>%
    summarize(
      wellbeing = mean(swb, na.rm=T),
      wealth = mean(dollars, na.rm=T)/1000
      ) -> df.deciles
  
  df %>%
    mutate(
      wealth = dollars/1000,
      wellbeing = swb
    ) -> df.plot
  
  # smooth
  ggplot(df.plot, aes(x = wealth, y = wellbeing)) +
    geom_smooth(aes(fill = "manual1", color = "manual2"),
      method = "gam", 
      size = 0.5
      ) +
    facet_wrap(~year, nrow = 1, scales = "free_x") +
    labs(subtitle = paste(rlang::as_name(swb_colname), "(deciles)"),
         x = paste(rlang::as_name(dollars_colname), "($000s)"),
         y = "") +
    theme_test() +
    theme(
      legend.position = "none") -> p1
  
  p1 +
    geom_point(data = df.deciles)  # size = 3, alpha = 0.25
    # geom_text(data = df.sum, aes(x = Inf, y = -Inf, label = note),
    #           hjust = 1.1, vjust = -.75, colour = 1, size = 3)
  
}
```

#### Unsummarized plots
```{r unsum_plot, fig.width=9}
happywealth_covs %>%
  rename(Happiness = gh9, `Household wealth` = adj_hifdip) %>% 
  filter(!student) %>%
  plot_all(Happiness, `Household wealth`) +
  scale_fill_manual(values = "#b3cde0") +
  scale_color_manual(values = "#005b96")
```

#### Equal interval bins
```{r cut_interval_plot, fig.width=9}
happywealth_covs %>%
  rename(Happiness = gh9, `Household wealth` = adj_hifdip) %>% 
  filter(!student) %>%
  plot_cut_interval(Happiness, `Household wealth`) +
  scale_fill_manual(values = "#b3cde0") +
  scale_color_manual(values = "#005b96")
```

#### Decile bins
```{r decile_plot, fig.width=9}
happywealth_covs %>%
  rename(Happiness = gh9, `Household wealth` = adj_hifdip) %>% 
  filter(!student) %>%
  plot_deciles(Happiness, `Household wealth`) +
  scale_fill_manual(values = "#b3cde0") +
  scale_color_manual(values = "#005b96")
```


